#!/usr/bin/env python3
# encoding: utf8

"""
url process
author: jlz
date: 2017-05-15
last modify: 2017-07-01
"""

import os
import cgi
import json
import random
import requests
import copy
import urllib
import traceback
import tldextract

from pprint import pprint
from urllib import parse
import j_pentest_utils

class Url(object):
    """
        this class represents a URL
        no getter function, access by attributes ( i dont like getter functions )
    """

    def __init__( self, url ):
        """
            url: string
        """
        self.url = j_pentest_utils.bytes_to_unicode( url )

        scheme, netloc, path, params, query, fragment = parse.urlparse( self.url )

        self.scheme = scheme
        self.netloc = netloc
        self.path = path
        self.params = params  # rare
        self.query = query
        self.fragment = fragment

        self.path_components = tuple( filter( None, self.path.split( '/' ) ) )
        self.query_components = parse.parse_qsl( self.query )
        # notice: i used parse_qsl instead of parse_qs ( notice the l )
        # example of query_components:  [('wd', 'wtf'), ('wd2', ''), ('wd', 'wtf2')]


    def _key( self ): # hash key
        p = self.path_components
        q = tuple( parse.parse_qs( self.query ).keys() )

        return ( self.netloc, p, q )


    def __hash__( self ):
        return hash( self._key() )


    def get_file_name(self):
        """
        :return: Returns the filename name for the given url.
        """
        return self.path[self.path.rfind('/') + 1:]


    def is_media( self ):
        """
            from path extract extension and guess file type based on that
        """
        media_ext = "flv,mp4,mp4,swf,jpg,jpeg,png,mp4,gif,pdf,rar,zip,avi,mp4,swf,wmi,exe,mpeg,ppt,pptx,doc,docx,xls,xlsx,apk"
        media_ext = filter( None, media_ext.split(',') )
        ext = self.get_ext()
        return ( (ext) and ( ext in media_ext ) )


    def should_sqli( self ):
        """
            from extension to determin whether should be test against sqli, static data no need to test
        """
        media_ext = "js,flv,mp4,mp4,swf,jpg,jpeg,png,mp4,gif,pdf,rar,zip,avi,mp4,swf,wmi,exe,mpeg,ppt,pptx,doc,docx,xls,xlsx,apk"
        media_ext = filter( None, media_ext.split(',') )
        ext = self.get_ext()
        return ( ext not in media_ext )


    def get_ext( self ):
        """
            get extension from url, so this is not reliable
            os.path.splitext is used to extract extension
        """
        path = parse.urlparse( self.url ).path
        ext = os.path.splitext(path)[1]
        return ext
